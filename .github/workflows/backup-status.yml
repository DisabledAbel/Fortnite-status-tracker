name: Update Fortnite Status & Backup

on:
  schedule:
    - cron: "*/5 * * * *" # Every 5 minutes
  workflow_dispatch:

jobs:
  update-and-backup:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout main repo
      - name: Checkout main repo
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. Install dependencies
      - name: Install dependencies
        run: npm install

      # 4. Run the status updater
      - name: Run status updater
        id: updater
        run: |
          node index.js

      # 5. Stop workflow if updater failed
      - name: Verify updater success
        if: failure()
        run: |
          echo "Updater failed! Skipping backup."
          exit 1

      # 6. Setup Git for backup repo
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 7. Clone backup repository using GITHUB_TOKEN
      - name: Clone backup repository
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/YourUsername/fortnite-status-backup.git backup-repo

      # 8. Copy updated JSON files with timestamp
      - name: Copy JSON files
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          mkdir -p backup-repo
          for file in public/status.json public/status-badge.json public/history.json; do
            [ -f "$file" ] || continue
            BASENAME=$(basename "$file" .json)
            cp "$file" "backup-repo/${BASENAME}_$TIMESTAMP.json"
          done

      # 9. Clean old backups (keep last 30 per file)
      - name: Clean old backups
        run: |
          for BASENAME in status status-badge history; do
            FILES=(backup-repo/${BASENAME}_*.json)
            COUNT=${#FILES[@]}
            if [ "$COUNT" -gt 30 ]; then
              TO_DELETE=$(($COUNT - 30))
              ls -1tr backup-repo/${BASENAME}_*.json | head -n $TO_DELETE | xargs rm -f
            fi
          done

      # 10. Commit & push to backup repo
      - name: Commit and push backups
        run: |
          cd backup-repo
          git add .
          git diff --cached --quiet || git commit -m "Backup: $TIMESTAMP"
          git push origin main
